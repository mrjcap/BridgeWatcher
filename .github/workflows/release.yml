name: Release Process

on:
  workflow_dispatch:
    inputs:
      version_bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch

permissions:
  contents: write
  pull-requests: write

jobs:
  pre-release:
    name: Pre-release Checks
    runs-on: ubuntu-latest
    steps:
      - name: Print start
        run: echo "ÎÎµÎºÎ¹Î½Î¬ÎµÎ¹ Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± release..."

  test:
    name: Module Tests
    needs: pre-release
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  codacy:
    name: Codacy Analysis
    needs: test
    uses: ./.github/workflows/codequality.yml
    secrets:
      CODACY_PROJECT_TOKEN: ${{ secrets.CODACY_PROJECT_TOKEN }}

  gatekeeper:
    name: Gatekeeper (Changelog builder)
    runs-on: ubuntu-latest
    needs: [pre-release, test, codacy]
    outputs:
      next_version: ${{ steps.determine_version.outputs.version }}
      changelog_changed: ${{ steps.detect_changelog_changes.outputs.changelog_changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0

      - name: Calculate potential next version
        id: determine_version
        shell: pwsh
        env:
          VERSION_BUMP_TYPE: ${{ github.event.inputs.version_bump_type }}
        run: |
          $version = & ./scripts/Get-PotentialNextVersion.ps1 -BumpType $Env:VERSION_BUMP_TYPE -Verbose
          Write-Host "Calculated version: $version"
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Build Changelog (mikepenz/release-changelog-builder-action)
        id: build_changelog
        uses: mikepenz/release-changelog-builder-action@5fb6e51e44d4aea73f66549f425aa3ed5008109e
        with:
          mode: 'HYBRID'
          outputFile: CHANGELOG.md
          includeOpen: false
          fetchViaCommits: true
          commitMode: false
          configurationJson: |
            {
              "template": "## [${{ steps.determine_version.outputs.version }}] - #{{TO_TAG_DATE}}\n\n#{{CHANGELOG}}\n\n---\n",
              "categories": [
                { "title": "### âœ¨ Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎ±Î½", "rules": [ { "pattern": "^(feat|feature|add|Ï€ÏÎ¿ÏƒÏ„Î­Î¸|Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ·|Î½Î­Î¿|new)", "flags": "i" } ] },
                { "title": "### ğŸ”„ Î‘Î»Î»Î±Î³Î­Ï‚", "rules": [ { "pattern": "^(change|changed|update|Î±Î»Î»Î±Î³|Ï„ÏÎ¿Ï€Î¿Ï€|Î¼ÎµÏ„Î±Î²|ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·(?!.*changelog)|refactor)", "flags": "i" } ] },
                { "title": "### âš ï¸ Î¥Ï€Î¿ÏˆÎ®Ï†Î¹Î± Ï€ÏÎ¿Ï‚ Î±Ï€ÏŒÏƒÏ…ÏÏƒÎ·", "rules": [ { "pattern": "^(deprecat|Ï…Ï€Î¿ÏˆÎ®Ï†Î¹Î± Ï€ÏÎ¿Ï‚ Î±Ï€ÏŒÏƒÏ…ÏÏƒÎ·|Ï€Î±ÏÏ‰Ï‡Î·Î¼|Î±Ï€ÏŒÏƒÏ…ÏÏƒÎ·)", "flags": "i" } ] },
                { "title": "### âŒ Î‘Ï†Î±Î¹ÏÎ­Î¸Î·ÎºÎ±Î½", "rules": [ { "pattern": "^(remove|removed|delete|ÎºÎ±Ï„Î±ÏÎ³|Î±Ï†Î±Î¯Ï|Î´Î¹Î±Î³ÏÎ¬)", "flags": "i" } ] },
                { "title": "### ğŸ› Î”Î¹Î¿ÏÎ¸ÏÎ¸Î·ÎºÎ±Î½", "rules": [ { "pattern": "^(fix|fixed|bug|bugfix|Î´Î¹Î¿ÏÎ¸|Î´Î¹ÏŒÏÎ¸|ÏƒÏ†Î±Î»Î¼|ÎµÏ€Î¹Î´Î¹Î¿ÏÎ¸|Î±Ï€Î¿ÎºÎ±Ï„Î±ÏƒÏ„)", "flags": "i" } ] },
                { "title": "### ğŸ”’ Î‘ÏƒÏ†Î¬Î»ÎµÎ¹Î±", "rules": [ { "pattern": "^(security|sec|Î±ÏƒÏ†Î¬Î»)", "flags": "i" } ] },
                { "title": "### ğŸ“ Î¤ÎµÎºÎ¼Î·ÏÎ¯Ï‰ÏƒÎ·", "rules": [ { "pattern": "^(docs|documentation|readme|Ï„ÎµÎºÎ¼Î·Ï|changelog)", "flags": "i" } ] },
                { "title": "### ğŸ”§ CI & Î£Ï…Î½Ï„Î®ÏÎ·ÏƒÎ·", "rules": [ { "pattern": "^(ci:|chore:|build:|test:|Î±Î½Î±Î²Î¬Î¸Î¼Î¹ÏƒÎ·)", "flags": "i" } ] }
              ],
              "pr_template": "- #{{TITLE}} ([#{{SHA_SHORT}}]({{URL}}))",
              "empty_template": "- ÎšÎ±Î¼Î¯Î± ÏƒÎ·Î¼Î±Î½Ï„Î¹ÎºÎ® Î±Î»Î»Î±Î³Î® ÏƒÎµ Î±Ï…Ï„Î® Ï„Î·Î½ Î­ÎºÎ´Î¿ÏƒÎ· ğŸ‰",
              "sort": { "order": "DESC", "on_property": "mergedAt" },
              "max_tags_to_fetch": 50,
              "ignore_labels": [ "duplicate", "question", "invalid", "wontfix", "skip-changelog" ]
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Detect CHANGELOG.md changes
        id: detect_changelog_changes
        run: |
          if git status --porcelain CHANGELOG.md | grep 'CHANGELOG.md'; then
            echo "changelog_changed=true" >> $GITHUB_OUTPUT
          else
            echo "changelog_changed=false" >> $GITHUB_OUTPUT
          fi

  changelog-pr:
    name: "Auto PR Î³Î¹Î± Î±Î»Î»Î±Î³Î® CHANGELOG.md"
    runs-on: ubuntu-latest
    needs: gatekeeper
    if: needs.gatekeeper.outputs.changelog_changed == 'true'
    outputs:
      changelog_pr_opened: ${{ steps.changelog_pr.outputs.changelog_pr_opened }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install GitHub CLI (gh)
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Authenticate gh CLI (safe)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "${GITHUB_TOKEN}" | gh auth login --with-token

      - name: Run Update-ChangelogAndCreatePR.ps1
        id: changelog_pr
        shell: pwsh
        run: |
          & ./scripts/Update-ChangelogAndCreatePR.ps1

      - name: Output PR status (audit)
        if: always()
        shell: pwsh
        run: |
          if (Test-Path $env:GITHUB_OUTPUT) {
            Write-Host '---- GITHUB_OUTPUT ----'
            Get-Content $env:GITHUB_OUTPUT
            Write-Host '-----------------------'
          }

  # Î¤Î± ÎµÏ€ÏŒÎ¼ÎµÎ½Î± jobs Ï„ÏÎ­Ï‡Î¿Ï…Î½ ÎœÎŸÎÎŸ ÏŒÏ„Î±Î½ Ï„Î¿ changelog Î´ÎµÎ½ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ PR (Î´Î·Î»Î±Î´Î® Î´ÎµÎ½ Î¬Î»Î»Î±Î¾Îµ)
  test-matrix:
    name: Multi-OS/Version Tests
    runs-on: ${{ matrix.os }}
    needs: [gatekeeper]
    if: needs.gatekeeper.outputs.changelog_changed == 'false'
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        pwsh_version: ['7.3.x', '7.4.x']
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Install Pester
        shell: pwsh
        run: Install-Module Pester -Force -Scope CurrentUser

      - name: Run Matrix Tests
        shell: pwsh
        run: |
          if (Test-Path ./Tests/PesterConfiguration.psd1) {
            Invoke-Pester -Configuration (Import-PowerShellDataFile ./Tests/PesterConfiguration.psd1)
          } else {
            Write-Error "PesterConfiguration.psd1 not found!"
            exit 1
          }

  docs:
    name: Documentation Generation
    needs: [gatekeeper, test-matrix]
    if: needs.gatekeeper.outputs.changelog_changed == 'false'
    uses: ./.github/workflows/powershell-docs.yml
    secrets: inherit

  publish:
    name: Publish Module
    needs: [gatekeeper, docs, test-matrix]
    if: needs.gatekeeper.outputs.changelog_changed == 'false'
    uses: ./.github/workflows/publish.yml
    with:
      next_version: ${{ needs.gatekeeper.outputs.next_version }}
    secrets: inherit

  docker:
    name: Docker Build & Push
    needs: [gatekeeper, publish, test-matrix]
    if:
      needs.gatekeeper.outputs.changelog_changed == 'false' &&
      needs.publish.outputs.module_published == 'true'
    uses: ./.github/workflows/docker-build.yml
    with:
      version: ${{ needs.gatekeeper.outputs.next_version }}
    secrets: inherit
