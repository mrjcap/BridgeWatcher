name: Release Orchestrator

on:
  workflow_dispatch:
    inputs:
      version_bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch
      force_release:
        description: 'Force release even if no significant changes detected'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Perform a dry run without publishing'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  security-events: write

env:
  POWERSHELL_TELEMETRY_OPTOUT: 1
  DOTNET_CLI_TELEMETRY_OPTOUT: 1

jobs:
  pre-release:
    name: Pre-release Validation
    runs-on: ubuntu-latest
    outputs:
      can_proceed: ${{ steps.validation.outputs.can_proceed }}
      validation_summary: ${{ steps.validation.outputs.summary }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0

      - name: Validate release conditions
        id: validation
        shell: bash
        run: |
          echo "ðŸ” Validating release conditions..."

          # Check if there are uncommitted changes
          if ! git diff --quiet; then
            echo "âŒ Uncommitted changes detected"
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            echo "summary=Uncommitted changes detected" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Check if we're on main/master branch
          CURRENT_BRANCH=$(git branch --show-current)
          if [[ "$CURRENT_BRANCH" != "main" && "$CURRENT_BRANCH" != "master" ]]; then
            echo "âŒ Release must be run from main/master branch (current: $CURRENT_BRANCH)"
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            echo "summary=Not on main branch" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Check for recent commits (unless force_release is true)
          if [[ "${{ inputs.force_release }}" != "true" ]]; then
            COMMITS_SINCE_LAST_TAG=$(git rev-list --count $(git describe --tags --abbrev=0 2>/dev/null || echo "HEAD~10")..HEAD 2>/dev/null || echo "10")
            if [[ "$COMMITS_SINCE_LAST_TAG" -lt "1" ]]; then
              echo "âš ï¸ No new commits since last release"
              echo "can_proceed=false" >> $GITHUB_OUTPUT
              echo "summary=No new commits since last release" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

          echo "âœ… Pre-release validation passed"
          echo "can_proceed=true" >> $GITHUB_OUTPUT
          echo "summary=All validations passed" >> $GITHUB_OUTPUT

  gatekeeper:
    name: Release Gatekeeper
    runs-on: ubuntu-latest
    needs: pre-release
    if: needs.pre-release.outputs.can_proceed == 'true'
    outputs:
      next_version: ${{ steps.determine_version.outputs.version }}
      changelog_updated: ${{ steps.changelog.outputs.updated }}
      proceed_with_release: ${{ steps.decide.outputs.proceed }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0

      - name: Setup PowerShell
        uses: milliewalky/setup-pwsh@111b66da66b9e4c068052ed1ae34fcbeb9adcf36
        with:
          pwsh-version: '7.4.x'

      - name: Calculate next version
        id: determine_version
        shell: pwsh
        run: |
          Write-Host "Calculating next version..." -ForegroundColor Green

          if (Test-Path "./scripts/Get-PotentialNextVersion.ps1") {
            try {
              $version = & ./scripts/Get-PotentialNextVersion.ps1 -BumpType '${{ inputs.version_bump_type }}' -Verbose
              Write-Host "âœ… Calculated version: $version" -ForegroundColor Green
              echo "version=$version" >> $env:GITHUB_OUTPUT
            } catch {
              Write-Error "âŒ Failed to calculate version: $_"
              exit 1
            }
          } else {
            Write-Error "âŒ Get-PotentialNextVersion.ps1 script not found!"
            exit 1
          }

      - name: Update Changelog from commits
        shell: pwsh
        run: |
          ./scripts/Update-ReleaseChangeLog.ps1 -Version ${{ steps.determine_version.outputs.version }} -Verbose

      - name: Check if changelog updated
        id: changelog_check
        shell: pwsh
        run: |
          $updated = (Get-Content ./changelog_updated.flag -Raw).Trim()
          "updated=$updated" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Decide whether to proceed
        id: decide
        run: |
          if [[ "${{ steps.changelog_check.outputs.updated }}" == "true" || "${{ inputs.force_release }}" == "true" ]]; then
            echo "proceed=true" >> $GITHUB_OUTPUT
            echo "ðŸš€ Proceeding with release"
          else
            echo "proceed=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸ No significant changes detected, skipping release"
          fi

  changelog-pr:
    name: Changelog Pull Request
    runs-on: ubuntu-latest
    needs: gatekeeper
    if: needs.gatekeeper.outputs.changelog_updated == 'true'
    outputs:
      pr_number: ${{ steps.create-pr.outputs.pull-request-number }}
      pr_url: ${{ steps.create-pr.outputs.pull-request-url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Recreate changelog changes
        uses: mikepenz/release-changelog-builder-action@5fb6e51e44d4aea73f66549f425aa3ed5008109e
        with:
          configuration: ".github/workflows/changelog-configuration.json"
          toTag: "v${{ needs.gatekeeper.outputs.next_version }}"
          mode: 'COMMIT'
          outputFile: CHANGELOG.md
          includeOpen: false
          fetchViaCommits: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            docs: auto-update CHANGELOG.md Î³Î¹Î± Î­ÎºÎ´Î¿ÏƒÎ· v${{ needs.gatekeeper.outputs.next_version }}

            Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Î¿Ï… CHANGELOG Î±Ï€ÏŒ Ï„Î¿ GitHub Actions workflow.
          title: "ðŸ“ Auto-update CHANGELOG.md Î³Î¹Î± v${{ needs.gatekeeper.outputs.next_version }}"
          body: |
            ## ðŸ¤– Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· CHANGELOG

            Î‘Ï…Ï„ÏŒ Ï„Î¿ PR Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± Î±Ï€ÏŒ Ï„Î¿ Release Process workflow.

            ### ðŸ“‹ Î‘Î»Î»Î±Î³Î­Ï‚
            - Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Î¿Ï… CHANGELOG.md Î¼Îµ Ï„Î¹Ï‚ Î½Î­ÎµÏ‚ Î±Î»Î»Î±Î³Î­Ï‚ Î³Î¹Î± Ï„Î·Î½ Î­ÎºÎ´Î¿ÏƒÎ· `v${{ needs.gatekeeper.outputs.next_version }}`
            - Version bump type: `${{ inputs.version_bump_type }}`

            ### âœ… Checklist
            - [ ] ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÏŒÏ„Î¹ Ï„Î¿ CHANGELOG Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½ÎµÎ¹ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ ÏƒÎ·Î¼Î±Î½Ï„Î¹ÎºÎ­Ï‚ Î±Î»Î»Î±Î³Î­Ï‚
            - [ ] ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î¿ÏÎ¸Î®Ï‚ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¹Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚ Ï„Ï‰Î½ Î±Î»Î»Î±Î³ÏŽÎ½
            - [ ] ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î¿ÏÎ¸Î¿Î³ÏÎ±Ï†Î¯Î±Ï‚ ÎºÎ±Î¹ Î¼Î¿ÏÏ†Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚

            ---
            *Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ Î±Ï€ÏŒ GitHub Actions* ðŸš€

            **Note:** Î‘Ï…Ï„ÏŒ Ï„Î¿ PR Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î³Î¯Î½ÎµÎ¹ merge Ï€ÏÎ¹Î½ ÏƒÏ…Î½ÎµÏ‡Î¹ÏƒÏ„ÎµÎ¯ Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± release.
          branch: changelog/update-v${{ needs.gatekeeper.outputs.next_version }}-${{ github.run_number }}
          delete-branch: true
          labels: |
            auto-changelog
            documentation
            release-prep
          assignees: ${{ github.actor }}

  quality-gate:
    name: Quality Gate
    needs: [gatekeeper]
    if: needs.gatekeeper.outputs.proceed_with_release == 'true' && needs.gatekeeper.outputs.changelog_updated == 'false'
    strategy:
      matrix:
        check: [tests, security, docs]
      fail-fast: true
    runs-on: ubuntu-latest

    steps:
      - name: Run quality checks
        run: |
          echo "Running ${{ matrix.check }} quality gate..."
          case "${{ matrix.check }}" in
            "tests")
              echo "Would run comprehensive tests"
              ;;
            "security")
              echo "Would run security scans"
              ;;
            "docs")
              echo "Would validate documentation"
              ;;
          esac

  test-matrix:
    name: Cross-Platform Tests
    needs: [gatekeeper, quality-gate]
    if: always() && needs.gatekeeper.outputs.proceed_with_release == 'true' && needs.gatekeeper.outputs.changelog_updated == 'false'
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  security-analysis:
    name: Security Analysis
    needs: [gatekeeper, quality-gate]
    if: always() && needs.gatekeeper.outputs.proceed_with_release == 'true' && needs.gatekeeper.outputs.changelog_updated == 'false'
    uses: ./.github/workflows/codequality.yml
    secrets: inherit

  docs-generation:
    name: Documentation Generation
    needs: [gatekeeper, test-matrix]
    if: always() && needs.gatekeeper.outputs.proceed_with_release == 'true' && needs.gatekeeper.outputs.changelog_updated == 'false'
    uses: ./.github/workflows/powershell-docs.yml
    secrets: inherit

  publish-module:
    name: Publish Module
    needs: [gatekeeper, test-matrix, security-analysis, docs-generation]
    if: |
      always() &&
      needs.gatekeeper.outputs.proceed_with_release == 'true' &&
      needs.gatekeeper.outputs.changelog_updated == 'false' &&
      needs.test-matrix.result == 'success' &&
      needs.security-analysis.result == 'success'
    uses: ./.github/workflows/publish.yml
    with:
      next_version: ${{ needs.gatekeeper.outputs.next_version }}
      dry_run: ${{ inputs.dry_run }}
    secrets: inherit

  docker-build:
    name: Docker Build & Push
    needs: [gatekeeper, publish-module]
    if: |
      always() &&
      needs.gatekeeper.outputs.proceed_with_release == 'true' &&
      needs.gatekeeper.outputs.changelog_updated == 'false' &&
      (needs.publish-module.outputs.module_published == 'true' || needs.publish-module.outputs.module_published == 'dry-run')
    uses: ./.github/workflows/docker-build.yml
    with:
      version: ${{ needs.gatekeeper.outputs.next_version }}
    secrets: inherit

  release-summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [gatekeeper, changelog-pr, publish-module, docker-build]
    if: always()

    steps:
      - name: Generate release summary
        shell: bash
        run: |
          echo "# ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Release Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ needs.gatekeeper.outputs.next_version || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Bump:** ${{ inputs.version_bump_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run:** ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Force Release:** ${{ inputs.force_release }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ“‹ Workflow Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Gatekeeper | ${{ needs.gatekeeper.result }} | ${{ needs.gatekeeper.outputs.proceed_with_release == 'true' && 'âœ… Proceed' || 'â¸ï¸ Skip' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Changelog PR | ${{ needs.changelog-pr.result || 'skipped' }} | ${{ needs.changelog-pr.outputs.pr_number && format('ðŸ“ PR #{0}', needs.changelog-pr.outputs.pr_number) || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Module Publish | ${{ needs.publish-module.result || 'skipped' }} | ${{ needs.publish-module.outputs.module_published || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.docker-build.result || 'skipped' }} | ${{ needs.docker-build.result == 'success' && 'âœ… Built' || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.changelog-pr.outputs.pr_url }}" != "" ]]; then
            echo "## ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
            echo "- [Changelog PR](${{ needs.changelog-pr.outputs.pr_url }})" >> $GITHUB_STEP_SUMMARY
          fi

          # Determine overall status
          if [[ "${{ needs.gatekeeper.outputs.proceed_with_release }}" == "true" && "${{ needs.publish-module.result }}" == "success" ]]; then
            echo "## âœ… Release Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.changelog-pr.outputs.pr_number }}" != "" ]]; then
            echo "## ðŸ“ Release Status: CHANGELOG PR CREATED" >> $GITHUB_STEP_SUMMARY
            echo "Please review and merge the changelog PR to continue with the release." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Release Status: FAILED or SKIPPED" >> $GITHUB_STEP_SUMMARY
          fi

  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: [release-summary]
    if: always()

    steps:
      - name: Cleanup artifacts
        run: |
          echo "ðŸ§¹ Performing cleanup..."
          # Any cleanup tasks would go here
          echo "âœ… Cleanup completed"