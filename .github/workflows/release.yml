name: Release Process

on:
  workflow_dispatch:
    inputs:
      version_bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  pre-release:
    name: Pre-release Checks
    runs-on: ubuntu-latest
    steps:
      - name: Print start
        run: echo "ÎÎµÎºÎ¹Î½Î¬ÎµÎ¹ Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± release..."

  test:
    name: Module Tests
    needs: pre-release
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  codacy:
    name: Codacy Analysis
    needs: test
    uses: ./.github/workflows/codequality.yml
    secrets:
      CODACY_PROJECT_TOKEN: ${{ secrets.CODACY_PROJECT_TOKEN }}

  gatekeeper:
    name: Gatekeeper (Changelog builder)
    runs-on: ubuntu-latest
    needs: [pre-release, test, codacy]
    outputs:
      next_version: ${{ steps.determine_version.outputs.version }}
      changelog_changed: ${{ steps.detect_changelog_changes.outputs.changelog_changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0

      - name: Calculate potential next version
        id: determine_version
        shell: pwsh
        env:
          VERSION_BUMP_TYPE: ${{ github.event.inputs.version_bump_type }}
        run: |
          $version = & ./scripts/Get-PotentialNextVersion.ps1 -BumpType $Env:VERSION_BUMP_TYPE -Verbose
          Write-Host "Calculated version: $version"
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Build Changelog (mikepenz/release-changelog-builder-action)
        id: build_changelog # Î¤Î¿ id Ï€Î±ÏÎ±Î¼Î­Î½ÎµÎ¹ Î¯Î´Î¹Î¿, Î´ÎµÎ½ Ï„Î¿ Î±Î»Î»Î¬Î¶Î¿Ï…Î¼Îµ
        uses: mikepenz/release-changelog-builder-action@5fb6e51e44d4aea73f66549f425aa3ed5008109e
        with:
          # Î‘Î›Î›Î‘Î“Î—: Î§ÏÎ®ÏƒÎ· ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÎ¿Ï Î±ÏÏ‡ÎµÎ¯Î¿Ï… configuration Î±Î½Ï„Î¯ Î³Î¹Î± inline JSON
          configuration: ".github/workflows/changelog-configuration.json"
          # Î‘Î›Î›Î‘Î“Î—: Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· toTag Î³Î¹Î± Î½Î± Î¾Î­ÏÎµÎ¹ Ï„Î¿ action Ï€Î¿Î¹Î± Î­ÎºÎ´Î¿ÏƒÎ· Ï†Ï„Î¹Î¬Ï‡Î½ÎµÎ¹
          toTag: "v${{ steps.determine_version.outputs.version }}"
          # Î‘Î›Î›Î‘Î“Î—: Î’Î¬Î¶Î¿Ï…Î¼Îµ mode: 'COMMIT' ÎºÎ±Î¸ÏÏ‚ Î²Î±ÏƒÎ¹Î¶ÏŒÎ¼Î±ÏƒÏ„Îµ ÏƒÎµ commit messages
          mode: 'COMMIT'
          outputFile: CHANGELOG.md
          includeOpen: false
          fetchViaCommits: true
          # commitMode: false # Î¤Î¿ mode: 'COMMIT' Ï…Ï€ÎµÏÎ¹ÏƒÏ‡ÏÎµÎ¹, Î¿Ï€ÏŒÏ„Îµ Î±Ï…Ï„ÏŒ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î±Ï†Î±Î¹ÏÎµÎ¸ÎµÎ¯ Î® Î½Î± Î³Î¯Î½ÎµÎ¹ true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEBUG: true # Î¤Î¿ Î±Ï†Î®Î½Î¿Ï…Î¼Îµ Î³Î¹Î± Ï„ÏÏÎ±, Ï‡ÏÎ®ÏƒÎ¹Î¼Î¿ Î³Î¹Î± debugging

      - name: Detect CHANGELOG.md changes
        id: detect_changelog_changes
        run: |
          if git status --porcelain CHANGELOG.md | grep 'CHANGELOG.md'; then
            echo "changelog_changed=true" >> $GITHUB_OUTPUT
          else
            echo "changelog_changed=false" >> $GITHUB_OUTPUT
          fi

  changelog-pr:
    name: "Auto PR Î³Î¹Î± Î±Î»Î»Î±Î³Î® CHANGELOG.md"
    runs-on: ubuntu-latest
    needs: gatekeeper
    if: needs.gatekeeper.outputs.changelog_changed == 'true'
    outputs:
      changelog_pr_opened: ${{ steps.create-pr.outputs.pull-request-number }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Build Changelog Again (Î³Î¹Î± Ï„Î¿ PR)
        uses: mikepenz/release-changelog-builder-action@5fb6e51e44d4aea73f66549f425aa3ed5008109e
        with:
          configuration: ".github/workflows/changelog-configuration.json"
          toTag: "v${{ needs.gatekeeper.outputs.next_version }}"
          mode: 'COMMIT'
          outputFile: CHANGELOG.md
          includeOpen: false
          fetchViaCommits: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEBUG: true # Î¤Î¿ Î±Ï†Î®Î½Î¿Ï…Î¼Îµ Î³Î¹Î± Ï„ÏÏÎ±

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            docs: auto-update CHANGELOG.md Î³Î¹Î± Î­ÎºÎ´Î¿ÏƒÎ· v${{ needs.gatekeeper.outputs.next_version }}
            
            Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Î¿Ï… CHANGELOG Î±Ï€ÏŒ Ï„Î¿ GitHub Actions workflow.
          title: "ğŸ“ Auto-update CHANGELOG.md Î³Î¹Î± v${{ needs.gatekeeper.outputs.next_version }}"
          body: |
            ## ğŸ¤– Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· CHANGELOG
            
            Î‘Ï…Ï„ÏŒ Ï„Î¿ PR Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± Î±Ï€ÏŒ Ï„Î¿ Release Process workflow.
            
            ### ğŸ“‹ Î‘Î»Î»Î±Î³Î­Ï‚
            - Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Î¿Ï… CHANGELOG.md Î¼Îµ Ï„Î¹Ï‚ Î½Î­ÎµÏ‚ Î±Î»Î»Î±Î³Î­Ï‚ Î³Î¹Î± Ï„Î·Î½ Î­ÎºÎ´Î¿ÏƒÎ· `v${{ needs.gatekeeper.outputs.next_version }}`
            
            ### âœ… Checklist
            - [ ] ÎˆÎ»ÎµÎ³Ï‡os ÏŒÏ„Î¹ Ï„Î¿ CHANGELOG Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½ÎµÎ¹ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ ÏƒÎ·Î¼Î±Î½Ï„Î¹ÎºÎ­Ï‚ Î±Î»Î»Î±Î³Î­Ï‚
            - [ ] ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î¿ÏÎ¸Î®Ï‚ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¹Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚ Ï„Ï‰Î½ Î±Î»Î»Î±Î³ÏÎ½
            - [ ] ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î¿ÏÎ¸Î¿Î³ÏÎ±Ï†Î¯Î±Ï‚ ÎºÎ±Î¹ Î¼Î¿ÏÏ†Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚
            
            ---
            *Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ Î±Ï€ÏŒ GitHub Actions* ğŸš€
          branch: changelog/update-v${{ needs.gatekeeper.outputs.next_version }}-${{ github.run_number }}
          branch-suffix: timestamp
          delete-branch: true
          labels: |
            auto-changelog
            documentation
          assignees: ${{ github.actor }}
          reviewers: ${{ github.actor }}

      - name: Enable Pull Request Automerge
        if: steps.create-pr.outputs.pull-request-number
        run: |
          echo "Pull Request created: #${{ steps.create-pr.outputs.pull-request-number }}"
          echo "URL: ${{ steps.create-pr.outputs.pull-request-url }}"

  test-matrix:
    name: Multi-OS/Version Tests
    runs-on: ${{ matrix.os }}
    needs: [changelog-pr]
    if: always() && needs.gatekeeper.outputs.changelog_changed == 'false'
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        pwsh_version: ['7.3.x', '7.4.x']
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Install Pester
        shell: pwsh
        run: Install-Module Pester -Force -Scope CurrentUser

      - name: Run Matrix Tests
        shell: pwsh
        run: |
          if (Test-Path ./Tests/PesterConfiguration.psd1) {
            Invoke-Pester -Configuration (Import-PowerShellDataFile ./Tests/PesterConfiguration.psd1)
          } else {
            Write-Error "PesterConfiguration.psd1 not found!"
            exit 1
          }

  docs:
    name: Documentation Generation
    needs: [gatekeeper, test-matrix]
    if: always() && needs.gatekeeper.outputs.changelog_changed == 'false'
    uses: ./.github/workflows/powershell-docs.yml
    secrets: inherit

  publish:
    name: Publish Module
    needs: [gatekeeper, docs, test-matrix]
    if: always() && needs.gatekeeper.outputs.changelog_changed == 'false'
    uses: ./.github/workflows/publish.yml
    with:
      next_version: ${{ needs.gatekeeper.outputs.next_version }}
    secrets: inherit

  docker:
    name: Docker Build & Push
    needs: [gatekeeper, publish, test-matrix]
    if: |
      always() &&
      needs.gatekeeper.outputs.changelog_changed == 'false' &&
      (needs.publish.outputs.module_published == 'true' || needs.publish.outputs.module_published == '') 
      # Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÎµÎ»Î­Î³Ï‡Î¿Ï… Î³Î¹Î± ÎºÎµÎ½Î® Ï„Î¹Î¼Î® ÏƒÏ„Î¿ module_published, ÎºÎ±Î¸ÏÏ‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î¼Î·Î½ Î¿ÏÎ¹ÏƒÏ„ÎµÎ¯ Î±Î½ Ï„Î¿ publish job Ï€Î±ÏÎ±Î»ÎµÎ¹Ï†Î¸ÎµÎ¯
      # Î® Î±Î½ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Î¿ÏÎ¹ÏƒÏ„ÎµÎ¯ Ï„Î¿ output ÏƒÏ„Î¿ publish.yml Ï…Ï€ÏŒ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ ÏƒÏ…Î½Î¸Î®ÎºÎµÏ‚.
      # Î™Î´Î±Î½Î¹ÎºÎ¬, Ï„Î¿ publish.yml Î¸Î± Ï€ÏÎ­Ï€ÎµÎ¹ Ï€Î¬Î½Ï„Î± Î½Î± ÎµÎ¾Î¬Î³ÎµÎ¹ Î¼Î¹Î± ÏƒÎ±Ï†Î® Ï„Î¹Î¼Î® (true/false).
    uses: ./.github/workflows/docker-build.yml
    with:
      version: ${{ needs.gatekeeper.outputs.next_version }}
    secrets: inherit
